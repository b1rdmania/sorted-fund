<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sorted.fund - Developer Dashboard</title>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <a href="index.html" class="navbar-brand">â›½ SORTED.FUND</a>
    <ul class="navbar-nav">
      <li><a href="index.html" class="active">Overview</a></li>
      <li><a href="projects.html">Projects</a></li>
      <li><a href="api-keys.html">API Keys</a></li>
      <li><a href="analytics.html">Analytics</a></li>
      <li><a href="funding.html">Funding</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <!-- Project Selector (Demo Mode) -->
    <div class="project-selector">
      <span class="project-selector-label">PROJECT:</span>
      <select id="projectSelector">
        <option value="">Loading...</option>
      </select>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title">Dashboard Overview</h1>
        <p class="page-subtitle">Real-time metrics for your gas station</p>
      </div>
      <div class="page-actions">
        <button onclick="window.location.href='funding.html'">ðŸ’° Add Funds</button>
        <button onclick="window.location.href='api-keys.html'" class="btn-secondary">ðŸ”‘ Generate API Key</button>
      </div>
    </div>

    <!-- Gas Tank Balance (Prominent Display) -->
    <div class="panel highlight">
      <div class="panel-header">â›½ GAS STATION BALANCE</div>
      <div class="panel-content">
        <div class="metric-card">
          <span class="metric-card-label">Current Balance</span>
          <span class="metric-card-value" id="gasTankBalance">Loading...</span>
          <span class="metric-card-subtitle" id="depositAddress">Deposit Address: Loading...</span>
        </div>
      </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-box-label">Total Sponsored</div>
        <div class="stat-box-value" id="totalSponsored">--</div>
        <div class="stat-box-change text-muted">All-time transactions</div>
      </div>

      <div class="stat-box">
        <div class="stat-box-label">Gas Saved</div>
        <div class="stat-box-value" id="totalGasSaved">--</div>
        <div class="stat-box-change text-muted">Total cost sponsored</div>
      </div>

      <div class="stat-box">
        <div class="stat-box-label">Active Users</div>
        <div class="stat-box-value" id="activeUsers">--</div>
        <div class="stat-box-change text-muted">Unique addresses</div>
      </div>

      <div class="stat-box">
        <div class="stat-box-label">Today's Activity</div>
        <div class="stat-box-value" id="todaySponsored">--</div>
        <div class="stat-box-change" id="dailyCapStatus">--</div>
      </div>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-2">
      <!-- Top Contracts -->
      <div class="panel">
        <div class="panel-header">ðŸ“Š TOP CONTRACTS</div>
        <div class="panel-content">
          <div id="topContractsContainer">
            <div class="loading">Loading contracts data</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="panel">
        <div class="panel-header">âš¡ QUICK ACTIONS</div>
        <div class="panel-content">
          <div class="quick-actions" style="flex-direction: column;">
            <button onclick="window.location.href='funding.html'" class="btn-block">
              ðŸ’° Add Funds to Gas Station
            </button>
            <button onclick="window.location.href='api-keys.html'" class="btn-block btn-secondary">
              ðŸ”‘ Generate New API Key
            </button>
            <button onclick="window.location.href='allowlist.html'" class="btn-block btn-secondary">
              âœ… Manage Allowlist
            </button>
            <button onclick="window.location.href='analytics.html'" class="btn-block btn-secondary">
              ðŸ“ˆ View Full Analytics
            </button>
          </div>

          <div style="margin-top: var(--spacing-lg); padding-top: var(--spacing-lg); border-top: var(--border-secondary);">
            <h3>Integration</h3>
            <div class="code-block" style="margin-top: var(--spacing-sm);">
<span class="text-muted">// Simple API call to sponsor gas:</span>
fetch('/sponsor/authorize', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY'
  },
  body: JSON.stringify({
    projectId: '<span id="quickProjectId">...</span>',
    user: '0x...',
    target: '0x...',
    selector: '0x...',
    estimatedGas: 500000
  })
})
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Events Log -->
    <div class="panel">
      <div class="panel-header">ðŸ“‹ RECENT ACTIVITY</div>
      <div class="panel-content p-0">
        <div class="event-log" id="eventsLog">
          <div class="loading" style="padding: var(--spacing-lg);">Loading recent events</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/api.js"></script>
  <script>
    // Configuration
    const CONFIG = {
      DEMO_MODE: true,
      DEFAULT_PROJECT_ID: 'test-game',
      REFRESH_INTERVAL: 30000, // 30 seconds
    };

    let currentProjectId = CONFIG.DEFAULT_PROJECT_ID;
    let refreshTimer = null;

    // Initialize dashboard
    async function init() {
      try {
        // Load projects for selector
        await loadProjects();

        // Load dashboard data
        await loadDashboard();

        // Set up auto-refresh
        startAutoRefresh();
      } catch (error) {
        console.error('Initialization error:', error);
        showError('Failed to initialize dashboard: ' + error.message);
      }
    }

    // Load projects for selector
    async function loadProjects() {
      try {
        const projects = await api.getAllProjects();

        const selector = document.getElementById('projectSelector');
        selector.innerHTML = projects.map(p =>
          `<option value="${p.id}" ${p.id === currentProjectId ? 'selected' : ''}>
            ${p.name} (${p.id})
          </option>`
        ).join('');

        selector.addEventListener('change', (e) => {
          currentProjectId = e.target.value;
          loadDashboard();
        });
      } catch (error) {
        console.error('Failed to load projects:', error);
        document.getElementById('projectSelector').innerHTML =
          `<option value="${currentProjectId}">${currentProjectId}</option>`;
      }
    }

    // Load all dashboard data
    async function loadDashboard() {
      await Promise.all([
        loadProjectInfo(),
        loadAnalytics(),
        loadRecentEvents()
      ]);
    }

    // Load project info (gas tank balance)
    async function loadProjectInfo() {
      try {
        const project = await api.getProject(currentProjectId);

        // Display gas tank balance
        const balance = formatWeiWithUnit(project.gasTankBalance || '0');
        document.getElementById('gasTankBalance').textContent = balance;

        // Display deposit address
        const depositAddr = project.depositAddress || 'Not set';
        document.getElementById('depositAddress').textContent =
          `Deposit Address: ${shortenAddress(depositAddr)}`;

        // Update quick integration code
        document.getElementById('quickProjectId').textContent = project.id;
      } catch (error) {
        console.error('Failed to load project info:', error);
        document.getElementById('gasTankBalance').textContent = 'Error';
      }
    }

    // Load analytics overview
    async function loadAnalytics() {
      try {
        const analytics = await api.getAnalyticsOverview(currentProjectId);

        // Update metrics
        document.getElementById('totalSponsored').textContent =
          formatNumber(analytics.totalSponsored);

        document.getElementById('totalGasSaved').textContent =
          formatWeiWithUnit(analytics.totalGasSaved);

        document.getElementById('activeUsers').textContent =
          formatNumber(analytics.activeUsers);

        document.getElementById('todaySponsored').textContent =
          formatNumber(analytics.today.sponsored);

        // Daily cap status
        const dailyCapEl = document.getElementById('dailyCapStatus');
        const capRemaining = formatWei(analytics.today.dailyCapRemaining);
        dailyCapEl.textContent = `${capRemaining} S remaining today`;
        dailyCapEl.className = 'stat-box-change text-muted';

        // Display top contracts
        displayTopContracts(analytics.topContracts);

      } catch (error) {
        console.error('Failed to load analytics:', error);
        showError('Failed to load analytics data');
      }
    }

    // Display top contracts
    function displayTopContracts(contracts) {
      const container = document.getElementById('topContractsContainer');

      if (!contracts || contracts.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-message">No contract data yet</div></div>';
        return;
      }

      container.innerHTML = contracts.map(contract => `
        <div class="stat-box" style="margin-bottom: var(--spacing-sm);">
          <div class="stat-box-label">${shortenAddress(contract.address)}</div>
          <div class="stat-box-value">${formatNumber(contract.calls)}</div>
          <div class="stat-box-change text-muted">${formatWeiWithUnit(contract.gasUsed)} gas used</div>
        </div>
      `).join('');
    }

    // Load recent events
    async function loadRecentEvents() {
      try {
        const eventsData = await api.getAnalyticsEvents(currentProjectId, {
          limit: 10,
          offset: 0
        });

        const logEl = document.getElementById('eventsLog');

        if (!eventsData.events || eventsData.events.length === 0) {
          logEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ“­</div>
              <div class="empty-state-message">No events yet</div>
              <div class="text-muted font-small">Sponsored transactions will appear here</div>
            </div>
          `;
          return;
        }

        logEl.innerHTML = eventsData.events.map(event => `
          <div class="event-log-item">
            <div class="event-log-time">${formatTime(event.created_at)}</div>
            <div class="event-log-message">
              <span class="text-muted">User:</span> ${shortenAddress(event.sender)}
              <span class="text-muted">â†’</span> ${shortenAddress(event.target)}
              <span class="text-muted">Gas:</span> ${formatNumber(event.actual_gas || event.estimated_gas)}
            </div>
            <div class="event-log-status">
              <span class="badge ${getStatusClass(event.status)}">${event.status}</span>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Failed to load events:', error);
        document.getElementById('eventsLog').innerHTML =
          '<div class="loading text-error">Failed to load events</div>';
      }
    }

    // Auto-refresh
    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);

      refreshTimer = setInterval(() => {
        loadDashboard();
      }, CONFIG.REFRESH_INTERVAL);
    }

    // Initialize on page load
    window.addEventListener('load', init);

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshTimer) clearInterval(refreshTimer);
    });
  </script>
</body>
</html>
