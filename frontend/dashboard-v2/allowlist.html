<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Allowlist - Sorted.fund</title>
  <link rel="stylesheet" href="assets/css/layout.css">
  <link rel="stylesheet" href="assets/css/buttons.css">
  <style>
    .info-banner {
      background: rgba(0, 170, 255, 0.1);
      border: 1px solid var(--color-accent-cyan);
      padding: var(--spacing-md) var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .allowlist-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--color-bg-secondary);
      border: var(--border-secondary);
      margin-bottom: var(--spacing-xl);
    }

    .allowlist-table th {
      background: rgba(0, 255, 0, 0.05);
      padding: var(--spacing-md) var(--spacing-lg);
      text-align: left;
      border-bottom: var(--border-muted);
      color: var(--color-text-primary);
      font-weight: bold;
      text-transform: uppercase;
      font-size: var(--font-size-sm);
    }

    .allowlist-table td {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: var(--border-muted);
      color: var(--color-text-secondary);
    }

    .allowlist-table tr:hover {
      background: rgba(0, 255, 0, 0.05);
    }

    .empty-state {
      text-align: center;
      padding: var(--spacing-xl);
      color: var(--color-text-muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: var(--spacing-md);
    }

    .guide-section {
      background: var(--color-bg-secondary);
      border: var(--border-secondary);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }

    .guide-section h3 {
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-md);
    }

    .guide-section p {
      color: var(--color-text-muted);
      margin-bottom: var(--spacing-sm);
      font-size: var(--font-size-sm);
    }

    .selectors-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--spacing-md);
    }

    .selectors-table th {
      background: rgba(0, 255, 0, 0.05);
      padding: var(--spacing-sm) var(--spacing-md);
      text-align: left;
      border-bottom: var(--border-muted);
      color: var(--color-text-primary);
      font-size: var(--font-size-sm);
    }

    .selectors-table td {
      padding: var(--spacing-sm) var(--spacing-md);
      border-bottom: 1px solid rgba(0, 255, 0, 0.1);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .selectors-table code {
      color: var(--color-text-primary);
      font-family: var(--font-mono);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- HEADER -->
    <header class="app-header">
      <div class="header-left">
        <a href="gas-station.html" class="header-brand">‚õΩ SORTED.FUND</a>
        <div class="header-balance">
          <div class="balance-item">
            <span class="balance-label">Gas Tank</span>
            <span class="balance-value">5.2450 S</span>
          </div>
          <div class="balance-item">
            <span class="balance-label">Today Used</span>
            <span class="balance-value">0.1234 S / 1.0000 S</span>
          </div>
        </div>
      </div>
      <div class="header-right">
        <button class="btn-add-funds" onclick="window.location.href='add-funds.html'">
          Add Funds
        </button>
      </div>
    </header>

    <!-- MAIN -->
    <div class="app-main">
      <!-- SIDEBAR -->
      <nav class="sidebar">
        <div class="sidebar-section">
          <a href="gas-station.html" class="sidebar-item">
            üè† Gas Station
          </a>
          <a href="access-keys.html" class="sidebar-item">
            üîë Access Keys
          </a>
          <a href="allowlist.html" class="sidebar-item active">
            ‚úÖ Allowlist
          </a>
          <a href="add-funds.html" class="sidebar-item">
            üí∞ Add Funds
          </a>
          <a href="transactions.html" class="sidebar-item">
            üìä Transactions
          </a>
        </div>
        <div class="sidebar-divider"></div>
        <div class="sidebar-section">
          <a href="live-demo.html" class="sidebar-item">
            üéÆ Live Demo
          </a>
          <a href="https://docs.sorted.fund" target="_blank" class="sidebar-item">
            üìñ Documentation
          </a>
        </div>
      </nav>

      <!-- CONTENT -->
      <main class="content">
        <div class="page-header">
          <h1 class="page-title">Allowlist</h1>
          <p class="page-subtitle">Control which contracts and functions can be sponsored</p>
        </div>

        <!-- INFO BANNER -->
        <div class="info-banner">
          üõ°Ô∏è <strong>How Allowlists Work:</strong> Only transactions calling allowlisted contract addresses + function selectors will be sponsored. This prevents abuse and controls your gas spending.
        </div>

        <div class="page-actions" style="margin-bottom: var(--spacing-lg);">
          <button onclick="openAddEntryModal()">Add Entry</button>
        </div>

        <!-- ALLOWLIST TABLE -->
        <table class="allowlist-table">
          <thead>
            <tr>
              <th>Contract Address</th>
              <th>Function Selector</th>
              <th>Status</th>
              <th>Added</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <code>0xEcca...96E3</code>
                <a href="https://testnet.soniclabs.com/address/0xEcca59045D7d0dcfDB6A627fEB3a39BC046196E3" target="_blank" style="color: var(--color-accent-cyan); margin-left: var(--spacing-xs);">‚Üó</a>
              </td>
              <td><code>0xd09de08a</code></td>
              <td>
                <span class="badge badge-enabled">Enabled</span>
              </td>
              <td>Jan 5, 2026</td>
              <td>
                <button class="btn-sm btn-danger" onclick="deleteEntry()">Delete</button>
              </td>
            </tr>
            <tr>
              <td>
                <code>0x1234...5678</code>
                <a href="https://testnet.soniclabs.com/address/0x1234567890abcdef" target="_blank" style="color: var(--color-accent-cyan); margin-left: var(--spacing-xs);">‚Üó</a>
              </td>
              <td><code>0xa9059cbb</code></td>
              <td>
                <span class="badge badge-enabled">Enabled</span>
              </td>
              <td>Jan 3, 2026</td>
              <td>
                <button class="btn-sm btn-danger" onclick="deleteEntry()">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- HOW TO FIND SELECTORS GUIDE -->
        <div class="guide-section">
          <h2 style="color: var(--color-text-primary); margin-bottom: var(--spacing-lg);">
            üìñ How to Find Function Selectors
          </h2>

          <h3>Method 1: From Contract ABI</h3>
          <p>If you have the contract ABI:</p>
          <div class="code-block">
const iface = new ethers.Interface(ABI);
const selector = iface.getFunction('functionName').selector;
// Returns: "0x12345678"
          </div>

          <h3 style="margin-top: var(--spacing-lg);">Method 2: Manual Calculation</h3>
          <p>Function selector = first 4 bytes of keccak256 hash:</p>
          <div class="code-block">
import { keccak256, toUtf8Bytes } from 'ethers';

const signature = 'increment()';  // Function signature
const hash = keccak256(toUtf8Bytes(signature));
const selector = hash.slice(0, 10);  // 0x + 8 hex chars
// Example: "0xd09de08a"
          </div>

          <h3 style="margin-top: var(--spacing-lg);">Common Function Selectors</h3>
          <table class="selectors-table">
            <thead>
              <tr>
                <th>Function</th>
                <th>Selector</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>transfer(address,uint256)</code></td>
                <td><code>0xa9059cbb</code></td>
              </tr>
              <tr>
                <td><code>approve(address,uint256)</code></td>
                <td><code>0x095ea7b3</code></td>
              </tr>
              <tr>
                <td><code>mint(address,uint256)</code></td>
                <td><code>0x40c10f19</code></td>
              </tr>
              <tr>
                <td><code>increment()</code></td>
                <td><code>0xd09de08a</code></td>
              </tr>
            </tbody>
          </table>
        </div>

      </main>
    </div>
  </div>

  <!-- Scripts -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/api.js"></script>
  <script>
    const currentProjectId = CONFIG.DEFAULT_PROJECT_ID;

    // Load allowlist from backend
    async function loadAllowlist() {
      try {
        const entries = await api.getAllowlist(currentProjectId);
        displayAllowlist(entries);
      } catch (error) {
        console.error('Failed to load allowlist:', error);
        showError('Failed to load allowlist');
      }
    }

    // Display allowlist entries
    function displayAllowlist(entries) {
      const tbody = document.querySelector('.allowlist-table tbody');

      if (!entries || entries.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; color: var(--color-text-muted); padding: var(--spacing-xl);">
              No allowlist entries yet. Add contracts and functions to start sponsoring gas.
            </td>
          </tr>
        `;
        return;
      }

      const html = entries.map(entry => `
        <tr>
          <td>
            <code>${shortenAddress(entry.target_contract)}</code>
            <a href="${CONFIG.EXPLORER_URL}/address/${entry.target_contract}"
               target="_blank"
               style="color: var(--color-accent-cyan); margin-left: var(--spacing-xs);">‚Üó</a>
          </td>
          <td><code>${entry.function_selector}</code></td>
          <td>
            <span class="badge ${entry.enabled ? 'badge-enabled' : 'badge-disabled'}">
              ${entry.enabled ? 'Enabled' : 'Disabled'}
            </span>
          </td>
          <td>${formatDate(entry.created_at)}</td>
          <td>
            <button class="btn-sm btn-danger" onclick="deleteEntry('${entry.target_contract}', '${entry.function_selector}')">
              Delete
            </button>
          </td>
        </tr>
      `).join('');

      tbody.innerHTML = html;
    }

    // Add new allowlist entry
    async function openAddEntryModal() {
      const contractAddress = prompt('Enter contract address (0x...):', '');
      if (!contractAddress) return;

      const functionSelector = prompt('Enter function selector (0x...):', '');
      if (!functionSelector) return;

      // Basic validation
      if (!contractAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
        showError('Invalid contract address. Must be 0x followed by 40 hex characters.');
        return;
      }

      if (!functionSelector.match(/^0x[a-fA-F0-9]{8}$/)) {
        showError('Invalid function selector. Must be 0x followed by 8 hex characters.');
        return;
      }

      try {
        await api.addAllowlistEntry(currentProjectId, {
          targetContract: contractAddress,
          functionSelector: functionSelector
        });

        alert('Allowlist entry added successfully!');
        await loadAllowlist();
      } catch (error) {
        console.error('Failed to add allowlist entry:', error);
        showError('Failed to add entry: ' + error.message);
      }
    }

    // Delete allowlist entry
    async function deleteEntry(contractAddress, functionSelector) {
      if (!confirm('Are you sure you want to delete this allowlist entry? Transactions to this contract+function will no longer be sponsored.')) {
        return;
      }

      try {
        await api.deleteAllowlistEntry(currentProjectId, {
          targetContract: contractAddress,
          functionSelector: functionSelector
        });

        alert('Allowlist entry deleted successfully!');
        await loadAllowlist();
      } catch (error) {
        console.error('Failed to delete entry:', error);
        showError('Failed to delete entry: ' + error.message);
      }
    }

    // Show error
    function showError(message) {
      alert(message);
    }

    // Initialize on load
    window.addEventListener('load', async () => {
      await loadAllowlist();
    });
  </script>
</body>
</html>
