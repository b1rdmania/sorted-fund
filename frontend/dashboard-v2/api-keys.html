<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Keys - Sorted.fund</title>
  <link rel="icon" type="image/png" href="sorted-favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
  <div class="app-layout">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <a href="index.html" class="sidebar-brand-text">
          <img src="assets/img/sorted-wordmark-short.svg" alt="Sorted" style="height: 48px;">
        </a>
      </div>

      <nav class="sidebar-nav">
        <ul class="sidebar-nav-list">
          <li class="sidebar-nav-item">
            <a href="dashboard.html" class="sidebar-nav-link">Overview</a>
          </li>
          <li class="sidebar-nav-item">
            <a href="api-keys.html" class="sidebar-nav-link active">API Keys</a>
          </li>
          <li class="sidebar-nav-item">
            <a href="allowlist.html" class="sidebar-nav-link">Allowlist</a>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <a href="#" onclick="Auth.logout(); return false;" class="sidebar-footer-link">Logout</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Project Selector -->
        <div class="project-selector">
          <span class="project-selector-label">Project</span>
          <select id="projectSelector">
            <option value="">Loading...</option>
          </select>
        </div>

        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h1 class="page-title">API Keys</h1>
            <p class="page-subtitle">Step 3 of setup: create keys your backend will use</p>
          </div>
          <div class="page-actions">
            <button onclick="openGenerateKeyModal()">Generate New Key</button>
          </div>
        </div>

        <div id="setupHintContainer"></div>

        <!-- Info Box -->
        <div class="info-box">
          <div class="info-box-title">API Key Security</div>
          <div>
            API keys authenticate your application to the Sorted.fund backend.
            Keep them secret. Never commit keys to git or expose them in client-side code.
            Keys are only shown once at creation - save them securely.
          </div>
        </div>

        <!-- API Keys Table -->
        <div class="panel">
          <div class="panel-header">Your API Keys</div>
          <div class="panel-content p-0">
            <div id="apiKeysContainer">
              <div class="loading" style="padding: var(--space-lg);">Loading API keys</div>
            </div>
          </div>
        </div>

        <!-- Usage Info Panel -->
        <div class="panel">
          <div class="panel-header">How to Use API Keys</div>
          <div class="panel-content">
            <p class="text-muted" style="font-size: 13px; margin-bottom: var(--space-sm);">
              Keep this server-side only. Put the key in your backend environment and send it as a Bearer token.
            </p>
            <div class="code-block" id="apiKeySnippet">
fetch('https://sorted-backend.onrender.com/sponsor/authorize', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_API_KEY_HERE'
  },
  body: JSON.stringify({
    projectId: '<span id="exampleProjectId">test-game</span>',
    user: '0x...',
    target: '0x...',
    selector: '0x...',
    estimatedGas: 500000,
    clientNonce: '0x...',
    chainId: 14601
  })
})
            </div>
            <div style="margin-top: var(--space-sm);">
              <button class="btn-secondary btn-sm" id="copyApiSnippetBtn" onclick="copyApiSnippet()">Copy Snippet</button>
            </div>

            <details open>
              <summary>Best-practice checklist</summary>
              <div>
                <ul style="margin-left: var(--space-lg); color: var(--text-secondary); font-size: 13px;">
                  <li>Store keys in environment variables</li>
                  <li>Never commit keys to source control</li>
                  <li>Use separate keys per environment</li>
                  <li>Rotate keys regularly and revoke on compromise</li>
                </ul>
              </div>
            </details>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Generate Key Modal -->
  <div id="generateKeyModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Generate New API Key</h2>
        <button class="modal-close" onclick="closeGenerateKeyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="rateLimitInput">Rate Limit (requests per minute)</label>
          <input type="number" id="rateLimitInput" value="100" min="1" max="1000">
        </div>

        <div class="warning-box">
          <div class="warning-box-title">Important</div>
          <div>
            The API key will only be shown <strong>once</strong>.
            Make sure to copy and save it securely before closing this window.
          </div>
        </div>

        <div id="generatedKeyDisplay" class="hidden" style="margin-top: var(--space-lg);">
          <div class="alert alert-success">
            API key generated successfully
          </div>

          <div class="form-group">
            <label>Your API Key</label>
            <div style="display: flex; gap: var(--space-sm);">
              <input type="text" id="generatedKeyValue" readonly style="margin-bottom: 0; font-family: var(--font-mono); font-size: var(--text-mono-sm);">
              <button onclick="copyApiKey()" class="btn-secondary" style="white-space: nowrap;">
                Copy
              </button>
            </div>
          </div>

          <div class="warning-box" style="margin-top: var(--space-md);">
            <strong>Save this key now.</strong> You won't be able to see it again.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button onclick="closeGenerateKeyModal()" class="btn-secondary">Close</button>
        <button id="generateKeyBtn" onclick="generateApiKey()">Generate Key</button>
      </div>
    </div>
  </div>

  <!-- Revoke Key Modal -->
  <div id="revokeKeyModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Revoke API Key</h2>
        <button class="modal-close" onclick="closeRevokeKeyModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-error">
          This action cannot be undone
        </div>
        <p style="color: var(--text-secondary); font-size: var(--text-body-sm);">
          Are you sure you want to revoke this API key?
        </p>
        <div class="code-block">
          Key: <span id="revokeKeyPreview">--</span>
        </div>
        <p class="text-muted" style="font-size: var(--text-body-sm);">
          Applications using this key will immediately stop working.
          You'll need to generate a new key and update your applications.
        </p>
      </div>
      <div class="modal-footer">
        <button onclick="closeRevokeKeyModal()" class="btn-secondary">Cancel</button>
        <button id="confirmRevokeBtn" onclick="confirmRevokeKey()" class="btn-danger">Revoke Key</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="assets/js/utils.js?v=2"></script>
  <script src="assets/js/api.js?v=2"></script>
  <script src="assets/js/auth.js?v=2"></script>
  <script src="assets/js/onboarding.js?v=1"></script>
  <script src="assets/js/projectSwitcher.js?v=2"></script>
  <script>
    let currentProject = null;
    let currentRevokeKeyId = null;

    async function init() {
      try {
        await Auth.requireAuth();
        const state = await OnboardingFlow.requireProjectOrRedirect('/dashboard.html?flow=setup&missing=project');
        if (!state) return;

        await ProjectSwitcher.renderSelector('projectSelector');
        currentProject = state.project || await ProjectSwitcher.getCurrentProject();

        document.getElementById('exampleProjectId').textContent = currentProject.id;
        renderSetupHint(state);
        await loadApiKeys();
      } catch (error) {
        console.error('Initialization error:', error);
        if (!error.message.includes('Authentication required')) {
          showError('Failed to initialize page: ' + error.message);
        }
      }
    }

    async function loadApiKeys() {
      try {
        if (!currentProject) return;

        const keys = await api.getApiKeys(currentProject.id);
        displayApiKeys(keys);
      } catch (error) {
        console.error('Failed to load API keys:', error);
        document.getElementById('apiKeysContainer').innerHTML =
          '<div class="loading text-error" style="padding: var(--space-lg);">Failed to load API keys</div>';
      }
    }

    function displayApiKeys(keys) {
      const container = document.getElementById('apiKeysContainer');
      const normalizedKeys = OnboardingFlow.normalizeApiKeys(keys);

      if (!normalizedKeys || normalizedKeys.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-message">No API keys yet</div>
            <div class="text-muted font-small">Generate your first API key to get started</div>
            <button onclick="openGenerateKeyModal()" style="margin-top: var(--space-md);">
              Generate API Key
            </button>
          </div>
        `;
        return;
      }

      const tableHTML = `
        <div class="data-table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Key Preview</th>
                <th>Rate Limit</th>
                <th>Issued</th>
                <th>Last Used</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${normalizedKeys.map(key => `
                <tr>
                  <td><code>${key.preview}...</code></td>
                  <td>${key.rateLimit} req/min</td>
                  <td>${formatDate(key.issuedAt)}</td>
                  <td>${key.lastUsedAt ? formatRelativeTime(key.lastUsedAt) : 'Never'}</td>
                  <td>
                    <span class="badge ${key.revokedAt ? 'badge-error' : 'badge-success'}">
                      ${key.revokedAt ? 'Revoked' : 'Active'}
                    </span>
                  </td>
                  <td>
                    ${!key.revokedAt ? `
                      <button onclick="openRevokeKeyModal(${key.id}, '${key.preview}')"
                              class="btn-sm btn-danger">
                        Revoke
                      </button>
                    ` : '<span class="text-muted">-</span>'}
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHTML;
    }

    function renderSetupHint(state) {
      const host = document.getElementById('setupHintContainer');
      if (!host) return;

      host.innerHTML = `
        <div class="alert alert-warning">
          ${state.hasApiKey
            ? `You already have ${state.activeApiKeyCount} active key(s). Generate another key only if you need environment separation.`
            : 'Generate your first API key, copy it to your backend env, then continue to allowlist setup.'}
        </div>
      `;
    }

    function openGenerateKeyModal() {
      document.getElementById('generateKeyModal').classList.remove('hidden');
      document.getElementById('generatedKeyDisplay').classList.add('hidden');
      document.getElementById('rateLimitInput').value = 100;
      document.getElementById('generateKeyBtn').disabled = false;
    }

    function closeGenerateKeyModal() {
      document.getElementById('generateKeyModal').classList.add('hidden');
    }

    async function generateApiKey() {
      const rateLimit = parseInt(document.getElementById('rateLimitInput').value);
      const btn = document.getElementById('generateKeyBtn');

      if (rateLimit < 1 || rateLimit > 1000) {
        showError('Rate limit must be between 1 and 1000');
        return;
      }

      if (!currentProject) {
        showError('No project selected');
        return;
      }

      try {
        setButtonLoading(btn, 'Generating...');

        const result = await api.generateApiKey(currentProject.id, { rateLimit });

        document.getElementById('generatedKeyValue').value = result.apiKey;
        document.getElementById('generatedKeyDisplay').classList.remove('hidden');

        btn.disabled = true;
        btn.textContent = 'Key Generated';

        await loadApiKeys();

        showSuccess('API key generated successfully. Make sure to copy it now.');
      } catch (error) {
        console.error('Failed to generate API key:', error);
        showError('Failed to generate API key: ' + error.message);
        unsetButtonLoading(btn);
      }
    }

    async function copyApiKey() {
      const keyValue = document.getElementById('generatedKeyValue').value;
      const success = await copyToClipboard(keyValue);

      if (success) {
        showSuccess('API key copied to clipboard');
      } else {
        showError('Failed to copy to clipboard');
      }
    }

    async function copyApiSnippet() {
      const snippet = document.getElementById('apiKeySnippet');
      const button = document.getElementById('copyApiSnippetBtn');
      if (!snippet || !button) return;

      const success = await copyToClipboard(snippet.innerText);
      if (!success) {
        showError('Failed to copy snippet');
        return;
      }

      const previous = button.textContent;
      button.textContent = 'Copied';
      setTimeout(() => {
        button.textContent = previous;
      }, 1200);
    }

    function openRevokeKeyModal(keyId, keyPreview) {
      currentRevokeKeyId = keyId;
      document.getElementById('revokeKeyPreview').textContent = keyPreview + '...';
      document.getElementById('revokeKeyModal').classList.remove('hidden');
    }

    function closeRevokeKeyModal() {
      document.getElementById('revokeKeyModal').classList.add('hidden');
      currentRevokeKeyId = null;
    }

    async function confirmRevokeKey() {
      if (!currentRevokeKeyId) return;

      const btn = document.getElementById('confirmRevokeBtn');

      try {
        setButtonLoading(btn, 'Revoking...');
        showError('Revoke functionality coming soon - backend endpoint needed');
        closeRevokeKeyModal();
      } catch (error) {
        console.error('Failed to revoke key:', error);
        showError('Failed to revoke key: ' + error.message);
      } finally {
        unsetButtonLoading(btn);
      }
    }

    window.addEventListener('load', init);
  </script>
</body>
</html>
