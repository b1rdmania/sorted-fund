<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sorted.fund - Developer Dashboard</title>
  <link rel="icon" type="image/png" href="sorted-favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
  <div class="app-layout">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <a href="dashboard.html" class="sidebar-brand-text">
          <img src="assets/img/sorted-wordmark-short.svg" alt="Sorted" style="height: 28px;">
        </a>
      </div>

      <nav class="sidebar-nav">
        <ul class="sidebar-nav-list">
          <li class="sidebar-nav-item">
            <a href="dashboard.html" class="sidebar-nav-link active">Overview</a>
          </li>
          <li class="sidebar-nav-item">
            <a href="api-keys.html" class="sidebar-nav-link">API Keys</a>
          </li>
          <li class="sidebar-nav-item">
            <a href="allowlist.html" class="sidebar-nav-link">Allowlist</a>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <a href="#" onclick="Auth.logout(); return false;" class="sidebar-footer-link">Logout</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Project Selector -->
        <div class="project-selector">
          <span class="project-selector-label">Project</span>
          <select id="projectSelector">
            <option value="">Loading...</option>
          </select>
        </div>

        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Real-time metrics for your gas station</p>
          </div>
          <div class="page-actions">
            <button onclick="window.location.href='api-keys.html'">Generate API Key</button>
            <button onclick="window.location.href='allowlist.html'" class="btn-secondary">Manage Allowlist</button>
          </div>
        </div>

        <!-- Gas Tank Balance -->
        <div class="panel highlight">
          <div class="panel-header">Gas Station Balance</div>
          <div class="panel-content">
            <div class="metric-card highlight" style="border: none; background: transparent;">
              <span class="metric-card-label">Current Balance</span>
              <span class="metric-card-value" id="gasTankBalance">Loading...</span>
              <span class="metric-card-subtitle" id="depositAddress">Deposit Address: Loading...</span>
            </div>
          </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-box-label">Total Sponsored</div>
            <div class="stat-box-value" id="totalSponsored">--</div>
            <div class="stat-box-change text-muted">All-time transactions</div>
          </div>

          <div class="stat-box">
            <div class="stat-box-label">Gas Saved</div>
            <div class="stat-box-value" id="totalGasSaved">--</div>
            <div class="stat-box-change text-muted">Total cost sponsored</div>
          </div>

          <div class="stat-box">
            <div class="stat-box-label">Active Users</div>
            <div class="stat-box-value" id="activeUsers">--</div>
            <div class="stat-box-change text-muted">Unique addresses</div>
          </div>

          <div class="stat-box">
            <div class="stat-box-label">Today's Activity</div>
            <div class="stat-box-value" id="todaySponsored">--</div>
            <div class="stat-box-change" id="dailyCapStatus">--</div>
          </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-2">
          <!-- Top Contracts -->
          <div class="panel">
            <div class="panel-header">Top Contracts</div>
            <div class="panel-content">
              <div id="topContractsContainer">
                <div class="loading">Loading contracts data</div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="panel">
            <div class="panel-header">Quick Actions</div>
            <div class="panel-content">
              <div class="quick-actions" style="flex-direction: column;">
                <button onclick="window.location.href='api-keys.html'" class="btn-block">
                  Generate New API Key
                </button>
                <button onclick="window.location.href='allowlist.html'" class="btn-block btn-secondary">
                  Manage Allowlist
                </button>
                <button onclick="window.location.href='demo.html'" class="btn-block btn-secondary">
                  View Live Demo
                </button>
              </div>

              <div style="margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--border);">
                <h3 style="margin-bottom: var(--space-sm);">Integration</h3>
                <div class="code-block" style="margin-top: var(--space-sm);">
<span class="text-muted">// Simple API call to sponsor gas:</span>
fetch('/sponsor/authorize', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY'
  },
  body: JSON.stringify({
    projectId: '<span id="quickProjectId">...</span>',
    user: '0x...',
    target: '0x...',
    selector: '0x...',
    estimatedGas: 500000
  })
})
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Events Log -->
        <div class="panel">
          <div class="panel-header">Recent Activity</div>
          <div class="panel-content p-0">
            <div class="event-log" id="eventsLog">
              <div class="loading" style="padding: var(--space-lg);">Loading recent events</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="assets/js/utils.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/projectSwitcher.js"></script>
  <script>
    const CONFIG = {
      REFRESH_INTERVAL: 30000,
    };

    let currentProject = null;
    let refreshTimer = null;

    async function init() {
      try {
        await Auth.requireAuth();
        await ProjectSwitcher.renderSelector('projectSelector');
        currentProject = await ProjectSwitcher.getCurrentProject();

        if (!currentProject) {
          showCreateProjectPrompt();
          return;
        }

        await loadDashboard();
        startAutoRefresh();
      } catch (error) {
        console.error('Initialization error:', error);
        if (!error.message.includes('Authentication required')) {
          showError('Failed to initialize dashboard: ' + error.message);
        }
      }
    }

    function showCreateProjectPrompt() {
      document.querySelector('.container').innerHTML = `
        <div style="text-align: center; padding: var(--space-3xl) var(--space-lg);">
          <h1 style="margin-bottom: var(--space-md);">Welcome to Sorted.fund</h1>
          <p style="color: var(--text-muted); margin-bottom: var(--space-lg);">Create your first project to get started</p>
          <button onclick="ProjectSwitcher.showCreateModal()" style="padding: var(--space-sm) var(--space-lg);">
            Create Project
          </button>
        </div>
      `;
    }

    async function loadDashboard() {
      await Promise.all([
        loadProjectInfo(),
        loadAnalytics(),
        loadRecentEvents()
      ]);
    }

    async function loadProjectInfo() {
      try {
        if (!currentProject) return;

        const balanceData = await ProjectSwitcher.getBalance(currentProject.id);
        const balance = formatWeiWithUnit(balanceData.balance || '0');
        document.getElementById('gasTankBalance').textContent = balance;

        const project = await api.getProject(currentProject.id);
        const depositAddr = project.deposit_address || '0x' + project.id.substring(0, 40).padStart(40, '0');
        document.getElementById('depositAddress').textContent =
          `Deposit Address: ${shortenAddress(depositAddr)}`;

        document.getElementById('quickProjectId').textContent = project.id;
      } catch (error) {
        console.error('Failed to load project info:', error);
        document.getElementById('gasTankBalance').textContent = 'Error loading balance';
      }
    }

    async function loadAnalytics() {
      try {
        if (!currentProject) return;

        const analytics = await api.getAnalyticsOverview(currentProject.id);

        document.getElementById('totalSponsored').textContent =
          formatNumber(analytics.totalSponsored);

        document.getElementById('totalGasSaved').textContent =
          formatWeiWithUnit(analytics.totalGasSaved);

        document.getElementById('activeUsers').textContent =
          formatNumber(analytics.activeUsers);

        document.getElementById('todaySponsored').textContent =
          formatNumber(analytics.today.sponsored);

        const dailyCapEl = document.getElementById('dailyCapStatus');
        const capRemaining = formatWei(analytics.today.dailyCapRemaining);
        dailyCapEl.textContent = `${capRemaining} S remaining today`;
        dailyCapEl.className = 'stat-box-change text-muted';

        displayTopContracts(analytics.topContracts);

      } catch (error) {
        console.error('Failed to load analytics:', error);
        showError('Failed to load analytics data');
      }
    }

    function displayTopContracts(contracts) {
      const container = document.getElementById('topContractsContainer');

      if (!contracts || contracts.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-message">No contract data yet</div></div>';
        return;
      }

      container.innerHTML = contracts.map(contract => `
        <div class="stat-box" style="margin-bottom: var(--space-sm);">
          <div class="stat-box-label">${shortenAddress(contract.address)}</div>
          <div class="stat-box-value">${formatNumber(contract.calls)}</div>
          <div class="stat-box-change text-muted">${formatWeiWithUnit(contract.gasUsed)} gas used</div>
        </div>
      `).join('');
    }

    async function loadRecentEvents() {
      try {
        if (!currentProject) return;

        const eventsData = await api.getAnalyticsEvents(currentProject.id, {
          limit: 10,
          offset: 0
        });

        const logEl = document.getElementById('eventsLog');

        if (!eventsData.events || eventsData.events.length === 0) {
          logEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-message">No events yet</div>
              <div class="text-muted font-small">Sponsored transactions will appear here</div>
            </div>
          `;
          return;
        }

        logEl.innerHTML = eventsData.events.map(event => `
          <div class="event-log-item">
            <div class="event-log-time">${formatTime(event.created_at)}</div>
            <div class="event-log-message">
              <span class="text-muted">User:</span> ${shortenAddress(event.sender)}
              <span class="text-muted">-></span> ${shortenAddress(event.target)}
              <span class="text-muted">Gas:</span> ${formatNumber(event.actual_gas || event.estimated_gas)}
            </div>
            <div class="event-log-status">
              <span class="badge ${getStatusClass(event.status)}">${event.status}</span>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Failed to load events:', error);
        document.getElementById('eventsLog').innerHTML =
          '<div class="loading text-error">Failed to load events</div>';
      }
    }

    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);

      refreshTimer = setInterval(() => {
        loadDashboard();
      }, CONFIG.REFRESH_INTERVAL);
    }

    window.addEventListener('load', init);

    window.addEventListener('beforeunload', () => {
      if (refreshTimer) clearInterval(refreshTimer);
    });
  </script>
</body>
</html>
