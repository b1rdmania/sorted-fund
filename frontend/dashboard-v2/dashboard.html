<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sorted.fund - Developer Dashboard</title>
  <link rel="icon" type="image/png" href="sorted-favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="assets/css/global.css">
  <link rel="stylesheet" href="assets/css/components.css">
</head>
<body>
  <div class="app-layout">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <a href="index.html" class="sidebar-brand-text">
          <img src="assets/img/sorted-wordmark-short.svg" alt="Sorted" style="height: 48px;">
        </a>
      </div>

      <nav class="sidebar-nav">
        <ul class="sidebar-nav-list">
          <li class="sidebar-nav-item">
            <a href="dashboard.html" class="sidebar-nav-link active">Overview</a>
          </li>
          <li class="sidebar-nav-item">
            <a href="api-keys.html" class="sidebar-nav-link">API Keys</a>
          </li>
          <li class="sidebar-nav-item">
            <a href="allowlist.html" class="sidebar-nav-link">Allowlist</a>
          </li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <a href="#" onclick="Auth.logout(); return false;" class="sidebar-footer-link">Logout</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Project Selector -->
        <div class="project-selector">
          <span class="project-selector-label">Project</span>
          <select id="projectSelector">
            <option value="">Loading...</option>
          </select>
        </div>

        <!-- Page Header -->
        <div class="page-header">
          <div>
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Real-time metrics for your gas station</p>
          </div>
          <div class="page-actions">
            <button onclick="window.location.href='api-keys.html'">Generate API Key</button>
            <button onclick="window.location.href='allowlist.html'" class="btn-secondary">Manage Allowlist</button>
          </div>
        </div>

        <!-- Gas Tank Balance -->
        <div class="panel highlight">
          <div class="panel-header">Gas Station Balance</div>
          <div class="panel-content">
            <div class="metric-card highlight" style="border: none; background: transparent;">
              <span class="metric-card-label">Current Balance</span>
              <span class="metric-card-value" id="gasTankBalance">Loading...</span>
              <span class="metric-card-subtitle" id="depositAddress">Sonic Funding Address: Loading...</span>
              <div style="margin-top: var(--space-sm); display: flex; gap: var(--space-sm); justify-content: center; align-items: center; flex-wrap: wrap;">
                <span style="font-size: 12px; color: var(--text-muted);">Parity Health:</span>
                <span id="parityHealth" class="badge badge-warning">Loading</span>
                <button id="copyFundingAddressBtn" class="btn-secondary btn-sm" onclick="copyFundingAddress()" disabled>Copy Address</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Key Metrics Grid -->
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-box-label">Total Sponsored</div>
            <div class="stat-box-value" id="totalSponsored">--</div>
            <div class="stat-box-change text-muted">All-time transactions</div>
          </div>

          <div class="stat-box">
            <div class="stat-box-label">Gas Saved</div>
            <div class="stat-box-value" id="totalGasSaved">--</div>
            <div class="stat-box-change text-muted">Total cost sponsored</div>
          </div>

          <div class="stat-box">
            <div class="stat-box-label">Active Users</div>
            <div class="stat-box-value" id="activeUsers">--</div>
            <div class="stat-box-change text-muted">Unique addresses</div>
          </div>

          <div class="stat-box">
            <div class="stat-box-label">Today's Activity</div>
            <div class="stat-box-value" id="todaySponsored">--</div>
            <div class="stat-box-change" id="dailyCapStatus">--</div>
          </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid grid-2">
          <!-- Top Contracts -->
          <div class="panel">
            <div class="panel-header">Top Contracts</div>
            <div class="panel-content">
              <div id="topContractsContainer">
                <div class="loading">Loading contracts data</div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="panel">
            <div class="panel-header">Quick Actions</div>
            <div class="panel-content">
              <div class="quick-actions" style="flex-direction: column;">
                <button onclick="window.location.href='api-keys.html'" class="btn-block">
                  Generate New API Key
                </button>
                <button onclick="window.location.href='allowlist.html'" class="btn-block btn-secondary">
                  Manage Allowlist
                </button>
                <button onclick="window.location.href='demo.html'" class="btn-block btn-secondary">
                  View Live Demo
                </button>
              </div>

              <div style="margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--border);">
                <h3 style="margin-bottom: var(--space-sm);">Integration</h3>
                <div class="code-block" style="margin-top: var(--space-sm);">
<span class="text-muted">// Simple API call to sponsor gas:</span>
fetch('/sponsor/authorize', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY'
  },
  body: JSON.stringify({
    projectId: '<span id="quickProjectId">...</span>',
    user: '0x...',
    target: '0x...',
    selector: '0x...',
    estimatedGas: 500000
  })
})
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Events Log -->
        <div class="panel">
          <div class="panel-header">Recent Activity</div>
          <div class="panel-content p-0">
            <div class="event-log" id="eventsLog">
              <div class="loading" style="padding: var(--space-lg);">Loading recent events</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="assets/js/utils.js?v=2"></script>
  <script src="assets/js/api.js?v=2"></script>
  <script src="assets/js/auth.js?v=2"></script>
  <script src="assets/js/projectSwitcher.js?v=2"></script>
  <script>
    const CONFIG = {
      REFRESH_INTERVAL: 30000,
    };

    let currentProject = null;
    let refreshTimer = null;
    let currentFundingAddress = null;
    const RUNTIME_CHAIN_ID = 14601;

    async function init() {
      try {
        await Auth.requireAuth();
        await ProjectSwitcher.renderSelector('projectSelector');
        currentProject = await ProjectSwitcher.getCurrentProject();

        if (!currentProject) {
          showNoProjectBanner();
          showEmptyDashboard();
        } else {
          await loadDashboard();
          startAutoRefresh();
        }
      } catch (error) {
        console.error('Initialization error:', error);
        if (!error.message.includes('Authentication required')) {
          showError('Failed to initialize dashboard: ' + error.message);
        }
      }
    }

    function showNoProjectBanner() {
      const banner = document.createElement('div');
      banner.className = 'no-project-banner';
      banner.innerHTML = `
        <div style="background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h3 style="margin: 0 0 4px 0;">Create your first project</h3>
            <p style="margin: 0; color: var(--text-muted); font-size: 14px;">Get an API key and start sponsoring transactions</p>
          </div>
          <button onclick="ProjectSwitcher.showCreateModal()">Create Project</button>
        </div>
      `;
      const container = document.querySelector('.container');
      const pageHeader = container.querySelector('.page-header');
      container.insertBefore(banner, pageHeader);
    }

    function showEmptyDashboard() {
      document.getElementById('gasTankBalance').textContent = '0 S';
      document.getElementById('depositAddress').textContent = 'Create a project to get your Sonic funding address';
      document.getElementById('parityHealth').textContent = 'N/A';
      document.getElementById('parityHealth').className = 'badge badge-warning';
      document.getElementById('copyFundingAddressBtn').disabled = true;
      document.getElementById('totalSponsored').textContent = '0';
      document.getElementById('totalGasSaved').textContent = '0 S';
      document.getElementById('activeUsers').textContent = '0';
      document.getElementById('todaySponsored').textContent = '0';
      document.getElementById('dailyCapStatus').textContent = 'No project selected';
      document.getElementById('topContractsContainer').innerHTML = '<div class="empty-state"><div class="empty-state-message">Create a project to see data</div></div>';
      document.getElementById('eventsLog').innerHTML = '<div class="empty-state" style="padding: 24px;"><div class="empty-state-message">No activity yet</div></div>';
      document.getElementById('quickProjectId').textContent = 'your-project-id';
    }

    async function loadDashboard() {
      await Promise.all([
        loadProjectInfo(),
        loadAnalytics(),
        loadRecentEvents()
      ]);
    }

    async function loadProjectInfo() {
      try {
        if (!currentProject) return;

        const balanceData = await ProjectSwitcher.getBalance(currentProject.id);
        const balance = formatWeiWithUnit(balanceData.balance || '0');
        document.getElementById('gasTankBalance').textContent = balance;

        let fundingResponse = null;
        try {
          fundingResponse = await api.getFundingAccountByChain(currentProject.id, RUNTIME_CHAIN_ID);
        } catch (error) {
          console.warn('Failed to load chain funding account, falling back to project deposit address:', error);
        }

        const project = await api.getProject(currentProject.id);
        const depositAddr =
          fundingResponse?.account?.deposit_address ||
          project.deposit_address ||
          null;

        currentFundingAddress = depositAddr;
        document.getElementById('depositAddress').textContent =
          `Sonic Funding Address: ${depositAddr ? shortenAddress(depositAddr) : 'Not available'}`;
        document.getElementById('copyFundingAddressBtn').disabled = !depositAddr;

        let parityData = null;
        if (balanceData && typeof balanceData.ledgerBalance !== 'undefined') {
          const cached = balanceData.balance || '0';
          const ledger = balanceData.ledgerBalance || '0';
          const delta = (BigInt(cached) - BigInt(ledger)).toString();
          parityData = { inSync: delta === '0', delta };
        } else {
          parityData = await api.getFundsParity(currentProject.id);
        }
        renderParityHealth(parityData);

        document.getElementById('quickProjectId').textContent = project.id;
      } catch (error) {
        console.error('Failed to load project info:', error);
        document.getElementById('gasTankBalance').textContent = 'Error loading balance';
        document.getElementById('parityHealth').textContent = 'Error';
        document.getElementById('parityHealth').className = 'badge badge-error';
      }
    }

    function renderParityHealth(parityData) {
      const badge = document.getElementById('parityHealth');
      if (!parityData) {
        badge.textContent = 'Unknown';
        badge.className = 'badge badge-warning';
        return;
      }

      if (parityData.inSync) {
        badge.textContent = 'In Sync';
        badge.className = 'badge badge-success';
      } else {
        const delta = parityData.delta || '0';
        badge.textContent = `Drift (${formatWei(delta)} S)`;
        badge.className = 'badge badge-error';
      }
    }

    async function copyFundingAddress() {
      if (!currentFundingAddress) return;

      try {
        await navigator.clipboard.writeText(currentFundingAddress);
        const btn = document.getElementById('copyFundingAddressBtn');
        const previous = btn.textContent;
        btn.textContent = 'Copied';
        setTimeout(() => {
          btn.textContent = previous;
        }, 1200);
      } catch (error) {
        console.error('Failed to copy funding address:', error);
        showError('Failed to copy funding address');
      }
    }

    async function loadAnalytics() {
      try {
        if (!currentProject) return;

        const analytics = await api.getAnalyticsOverview(currentProject.id);

        document.getElementById('totalSponsored').textContent =
          formatNumber(analytics.totalSponsored);

        document.getElementById('totalGasSaved').textContent =
          formatWeiWithUnit(analytics.totalGasSaved);

        document.getElementById('activeUsers').textContent =
          formatNumber(analytics.activeUsers);

        document.getElementById('todaySponsored').textContent =
          formatNumber(analytics.today.sponsored);

        const dailyCapEl = document.getElementById('dailyCapStatus');
        const capRemaining = formatWei(analytics.today.dailyCapRemaining);
        dailyCapEl.textContent = `${capRemaining} S remaining today`;
        dailyCapEl.className = 'stat-box-change text-muted';

        displayTopContracts(analytics.topContracts);

      } catch (error) {
        console.error('Failed to load analytics:', error);
        showError('Failed to load analytics data');
      }
    }

    function displayTopContracts(contracts) {
      const container = document.getElementById('topContractsContainer');

      if (!contracts || contracts.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-message">No contract data yet</div></div>';
        return;
      }

      container.innerHTML = contracts.map(contract => `
        <div class="stat-box" style="margin-bottom: var(--space-sm);">
          <div class="stat-box-label">${shortenAddress(contract.address)}</div>
          <div class="stat-box-value">${formatNumber(contract.calls)}</div>
          <div class="stat-box-change text-muted">${formatWeiWithUnit(contract.gasUsed)} gas used</div>
        </div>
      `).join('');
    }

    async function loadRecentEvents() {
      try {
        if (!currentProject) return;

        const eventsData = await api.getAnalyticsEvents(currentProject.id, {
          limit: 10,
          offset: 0
        });

        const logEl = document.getElementById('eventsLog');

        if (!eventsData.events || eventsData.events.length === 0) {
          logEl.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-message">No events yet</div>
              <div class="text-muted font-small">Sponsored transactions will appear here</div>
            </div>
          `;
          return;
        }

        logEl.innerHTML = eventsData.events.map(event => `
          <div class="event-log-item">
            <div class="event-log-time">${formatTime(event.created_at)}</div>
            <div class="event-log-message">
              <span class="text-muted">User:</span> ${shortenAddress(event.sender)}
              <span class="text-muted">-></span> ${shortenAddress(event.target)}
              <span class="text-muted">Gas:</span> ${formatNumber(event.actual_gas || event.estimated_gas)}
            </div>
            <div class="event-log-status">
              <span class="badge ${getStatusClass(event.status)}">${event.status}</span>
            </div>
          </div>
        `).join('');

      } catch (error) {
        console.error('Failed to load events:', error);
        document.getElementById('eventsLog').innerHTML =
          '<div class="loading text-error">Failed to load events</div>';
      }
    }

    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);

      refreshTimer = setInterval(() => {
        loadDashboard();
      }, CONFIG.REFRESH_INTERVAL);
    }

    window.addEventListener('load', init);

    window.addEventListener('beforeunload', () => {
      if (refreshTimer) clearInterval(refreshTimer);
    });
  </script>
</body>
</html>
